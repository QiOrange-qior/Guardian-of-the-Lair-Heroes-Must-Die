<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¢ç©´çš„å®ˆæŠ¤è€…ï¼šè‹±é›„å¿…é¡»æ­»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&display=swap');
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0f0505; /* dark red-black */
            color: #d6d3d1;
        }
        
        .parchment {
            background-color: #1a0505; /* deep dark red */
            border: 1px solid #450a0a; /* dark red border */
            box-shadow: 0 4px 20px rgba(0,0,0,0.95);
        }

        .parchment-inset {
            background-color: #0f0202;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.9);
        }

        .btn-action {
            background: linear-gradient(to bottom, #450a0a, #2a0404);
            border: 1px solid #7f1d1d;
            color: #fecaca;
            padding: 8px 16px;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: center;
            cursor: pointer;
            text-shadow: 0 1px 2px black;
        }

        .btn-action:hover {
            background: linear-gradient(to bottom, #7f1d1d, #450a0a);
            border-color: #f87171;
            color: #fff;
            transform: translateY(-1px);
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .log-entry {
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid #2a0404;
            animation: fadeIn 0.5s ease;
        }

        .text-highlight { color: #f87171; } /* red-400 */
        .text-magic { color: #c084fc; } /* purple-400 */
        .text-gold { color: #fcd34d; } /* amber-300 */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f0505; }
        ::-webkit-scrollbar-thumb { background: #450a0a; }

        .scene-pan {
            animation: panImage 40s infinite alternate linear;
        }
        @keyframes panImage {
            from { transform: scale(1.0); }
            to { transform: scale(1.15); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]">

    <!-- Header -->
    <header class="w-full max-w-5xl mb-2 flex justify-between items-end border-b border-red-900/30 pb-2">
        <div>
            <h1 class="text-2xl font-bold text-red-100 tracking-wider" style="text-shadow: 0 0 10px #7f1d1d;">å·¢ç©´çš„å®ˆæŠ¤è€…ï¼šè‹±é›„å¿…é¡»æ­»</h1>
            <p class="text-xs text-red-400 italic">Dungeon Guardian: Heroes Must Die</p>
        </div>
        <div class="text-right text-xs text-red-500 font-mono">
            <span id="wave-display">WAVE 0/10</span> | <span id="gold-display" class="text-gold">0 GOLD</span>
        </div>
    </header>

    <!-- Main Game Container -->
    <div class="w-full max-w-5xl flex flex-col gap-3">
        
        <!-- Top: Scene Display -->
        <div class="parchment p-1 w-full h-[50vh] min-h-[300px] max-h-[500px] rounded overflow-hidden relative group">
            <div id="loading-overlay" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-20 hidden backdrop-blur-sm">
                <div class="text-center">
                    <div class="text-red-500 text-sm mb-2 font-bold tracking-widest">æ­£åœ¨æ„ç­‘å¹»è±¡...</div>
                    <div class="w-24 h-0.5 bg-red-900 mx-auto"><div class="h-full bg-red-500 animate-pulse"></div></div>
                </div>
            </div>
            
            <img id="scene-image" src="https://image.pollinations.ai/prompt/massive%20dragon%20eye%20close%20up%20opening%20in%20darkness%20fiery%20reflection%20cinematic%20fantasy%20horror?width=1280&height=720&nologo=true" 
                 alt="Scene" class="w-full h-full object-cover scene-pan opacity-90">
            
            <!-- Dynamic Status Overlay on Image -->
            <div class="absolute bottom-4 left-4 z-10 bg-black/60 p-2 rounded border border-red-900/50 backdrop-blur-sm">
                <div class="text-xs text-red-300 uppercase tracking-widest mb-1">Dungeon Status</div>
                <div class="flex gap-4 text-xs font-mono">
                    <div class="text-stone-300">ğŸ›¡ï¸ é™·é˜±ç­‰çº§: <span id="trap-lvl" class="text-white">1</span></div>
                    <div class="text-stone-300">ğŸ‘¿ ä»†ä»æ•°é‡: <span id="minion-count" class="text-white">0</span></div>
                </div>
            </div>
        </div>

        <!-- Bottom: Info & Controls Grid -->
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 h-[280px]">
            
            <!-- Bottom Left: Boss Stats (3 cols) -->
            <div class="md:col-span-3 parchment p-3 rounded flex flex-col justify-between relative overflow-hidden">
                <!-- Dragon Background watermark -->
                <div class="absolute -right-4 -bottom-4 text-9xl opacity-5 pointer-events-none text-red-500 select-none">ğŸ²</div>
                
                <div>
                    <h3 class="text-sm font-bold text-red-400 border-b border-red-900/50 pb-1 mb-2 uppercase tracking-widest">BOSS çŠ¶æ€</h3>
                    <div class="space-y-1 text-xs text-stone-400">
                        <div class="flex justify-between"><span class="text-red-900/70 font-bold">NAME</span> <span class="text-red-200">è¿œå¤çº¢é¾™Â·ç“¦å°”å“ˆæ‹‰</span></div>
                        <div class="flex justify-between"><span class="text-red-900/70 font-bold">TYPE</span> <span class="text-red-200">ç¾å„çº§ç”Ÿç‰©</span></div>
                        
                        <div class="mt-4">
                            <div class="flex justify-between mb-1 text-[10px] uppercase text-red-500 font-bold"><span>Boss HP</span> <span id="hp-text">1000/1000</span></div>
                            <div class="w-full bg-stone-900 h-2 rounded overflow-hidden border border-red-900/30">
                                <div id="hp-bar" class="bg-gradient-to-r from-red-900 to-red-600 h-full transition-all duration-500" style="width: 100%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-2 text-center bg-red-950/30 p-2 rounded border border-red-900/20">
                    <div class="text-[10px] text-red-500 uppercase tracking-widest">Dragon Power</div>
                    <div id="boss-power" class="font-bold text-red-100 text-xl font-mono" style="text-shadow: 0 0 5px red;">100</div>
                </div>
            </div>

            <!-- Bottom Right: Log & Actions (9 cols) -->
            <div class="md:col-span-9 parchment p-0 rounded flex flex-col overflow-hidden relative">
                <!-- Log Area -->
                <div id="game-log" class="flex-1 overflow-y-auto p-3 font-medium text-stone-300 text-xs leading-relaxed parchment-inset m-1 rounded mb-0 font-mono">
                    <div class="log-entry text-red-400 italic">
                        å…¬ä¼šè°ƒåº¦å‘˜ï¼šå–‚ï¼Œé‚£è¾¹çš„å¤§å®¶ä¼™ï¼Œé†’é†’ï¼ä½ çš„èµ·åºŠæ°”æœ€å¥½å¤§ä¸€ç‚¹ï¼Œå› ä¸ºç¬¬ä¸€æ‰¹é€æ­»çš„â€œè‹±é›„â€å·²ç»åœ¨è·¯ä¸Šäº†...
                    </div>
                </div>

                <!-- Action Area -->
                <div id="action-area" class="p-2 border-t border-red-900/30 bg-[#1a0505]">
                    <div id="controls" class="grid grid-cols-3 gap-2">
                        <button onclick="game.start()" class="btn-action col-span-3 font-bold tracking-widest text-red-100 text-lg">è‹é†’ (å¼€å§‹æ¸¸æˆ)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        const game = {
            state: {
                wave: 0,
                maxWaves: 10,
                gold: 500, // Initial gold
                boss: {
                    maxHp: 2000,
                    hp: 2000,
                    power: 150
                },
                lair: {
                    trapLevel: 1,
                    trapPower: 50,
                    minions: 0,
                    minionPower: 0 // Total minion power
                },
                heroes: null // Current wave heroes
            },

            utils: {
                log: (text, type = 'normal') => {
                    const logEl = document.getElementById('game-log');
                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    if (type === 'dispatcher') div.className += ' text-red-400 italic';
                    if (type === 'combat') div.className += ' text-stone-100';
                    if (type === 'gain') div.className += ' text-gold';
                    if (type === 'danger') div.className += ' text-highlight font-bold';
                    
                    div.innerHTML = text;
                    logEl.appendChild(div);
                    logEl.scrollTop = logEl.scrollHeight;
                },
                
                updateUI: () => {
                    const s = game.state;
                    document.getElementById('wave-display').innerText = `WAVE ${s.wave}/${s.maxWaves}`;
                    document.getElementById('gold-display').innerText = `${s.gold} GOLD`;
                    document.getElementById('trap-lvl').innerText = `LV ${s.lair.trapLevel}`;
                    document.getElementById('minion-count').innerText = s.lair.minions;
                    
                    document.getElementById('hp-text').innerText = `${s.boss.hp}/${s.boss.maxHp}`;
                    const hpPct = (s.boss.hp / s.boss.maxHp) * 100;
                    document.getElementById('hp-bar').style.width = `${Math.max(0, hpPct)}%`;
                    document.getElementById('boss-power').innerText = s.boss.power;
                },

                setImage: (prompt) => {
                    const overlay = document.getElementById('loading-overlay');
                    const img = document.getElementById('scene-image');
                    overlay.classList.remove('hidden');
                    
                    const seed = Math.floor(Math.random() * 9999);
                    const finalPrompt = encodeURIComponent(`dark fantasy rpg art, ${prompt}, dragon perspective, epic scale, volumetric lighting, 8k resolution, cinematic --seed ${seed}`);
                    const url = `https://image.pollinations.ai/prompt/${finalPrompt}?width=1280&height=720&nologo=true`;
                    
                    const temp = new Image();
                    temp.onload = () => { img.src = url; overlay.classList.add('hidden'); };
                    temp.src = url;
                }
            },

            start: () => {
                game.state.wave = 1;
                game.utils.log("ã€å…¬ä¼šè°ƒåº¦å‘˜ã€‘ï¼šå¥½æˆå¼€åœºäº†ï¼è¿™æ˜¯ç¬¬ä¸€æ‰¹æ•¢æ­»é˜Ÿã€‚ä½ æœ‰ 500 é‡‘å¸çš„é¢„ç®—ï¼Œåˆ«è®©æˆ‘å¤±æœ›ï¼ŒæŠŠä½ çš„çªè£…ä¿®å¾—â€œå‡¶é™©â€ä¸€ç‚¹ï¼", 'dispatcher');
                game.constructionPhase();
            },

            constructionPhase: () => {
                game.utils.updateUI();
                game.utils.setImage("inside a massive dragon lair cave treasure pile dark shadows glowing lava veins first person view of dragon claws");
                
                const s = game.state;
                const costTrap = s.lair.trapLevel * 200;
                const costMinion = 150;
                const costHeal = 300;

                game.utils.log(`== å»ºè®¾é˜¶æ®µ (Wave ${s.wave}) ==`, 'highlight');
                game.utils.log(`å½“å‰æ‹¥æœ‰: ${s.gold} é‡‘å¸ã€‚è¯·ä¸‹è¾¾æŒ‡ä»¤ã€‚`);

                const buttons = [
                    {
                        text: `å‡çº§é™·é˜± (-${costTrap}G)`,
                        action: () => {
                            if (s.gold >= costTrap) {
                                s.gold -= costTrap;
                                s.lair.trapLevel++;
                                s.lair.trapPower += 50; // Flat increase
                                game.utils.log(`é™·é˜±å·²å‡çº§ï¼å½“å‰ç­‰çº§ LV${s.lair.trapLevel}ã€‚æ•´ä¸ªå·¢ç©´å……æ»¡äº†è‡´å‘½çš„æœºå…³ã€‚`, 'gain');
                                game.constructionPhase();
                            } else {
                                game.utils.log("é‡‘å¸ä¸è¶³ï¼å…¬ä¼šå¯ä¸æä¾›èµŠè´¦æœåŠ¡ã€‚", 'dispatcher');
                            }
                        }
                    },
                    {
                        text: `æ‹›å‹Ÿç‹—å¤´äººä»†ä» (-${costMinion}G)`,
                        action: () => {
                            if (s.gold >= costMinion) {
                                s.gold -= costMinion;
                                s.lair.minions += 10;
                                s.lair.minionPower += 40; // 10 minions = 40 power
                                game.utils.log(`ä½ æ‹›å‹Ÿäº†ä¸€ç¾¤åµé—¹çš„ç‹—å¤´äººã€‚è™½ç„¶å¾ˆå¼±ï¼Œä½†èƒœåœ¨æ•°é‡ã€‚`, 'gain');
                                game.constructionPhase();
                            } else {
                                game.utils.log("æ²¡é’±ï¼Ÿè¿ç‹—å¤´äººéƒ½çœ‹ä¸èµ·ä½ ã€‚", 'dispatcher');
                            }
                        }
                    },
                    {
                        text: `åå™¬è´¢å®å›è¡€ (-${costHeal}G)`,
                        action: () => {
                            if (s.gold >= costHeal) {
                                s.gold -= costHeal;
                                s.boss.hp = Math.min(s.boss.hp + 500, s.boss.maxHp);
                                game.utils.log(`ä½ åå™¬äº†ä¸€äº›è´¢å®ï¼Œç”Ÿå‘½å€¼æ¢å¤äº†ã€‚`, 'magic');
                                game.constructionPhase();
                            } else {
                                game.utils.log("ä½ çš„è´¢å®åº“ç©ºäº†ï¼Œå¿ç€å§ã€‚", 'dispatcher');
                            }
                        }
                    },
                    {
                        text: "ã€ è¿ æˆ˜ ã€‘",
                        full: true,
                        action: () => game.waveStart()
                    }
                ];

                const controls = document.getElementById('controls');
                controls.innerHTML = '';
                controls.className = 'grid grid-cols-2 gap-2'; // 2 cols for build phase

                buttons.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = 'btn-action';
                    b.innerText = btn.text;
                    b.onclick = btn.action;
                    if (btn.full) b.className += ' col-span-2 font-bold text-red-100 bg-red-900 border-red-500';
                    controls.appendChild(b);
                });
            },

            waveStart: () => {
                const wave = game.state.wave;
                // Generate Hero Wave Stats
                // Hero power scales exponentially
                const heroPower = Math.floor(100 * Math.pow(1.2, wave));
                const heroHp = Math.floor(200 * Math.pow(1.15, wave));
                const loot = Math.floor(300 * Math.pow(1.1, wave));
                
                const heroTypes = ["æ–°æ‰‹å†’é™©å›¢", "èµ„æ·±é›‡ä½£å…µ", "çš‡å®¶éª‘å£«å›¢", "å± é¾™å‹‡è€…å°é˜Ÿ", "ä¼ å¥‡è‹±é›„åŒç›Ÿ"];
                const heroName = heroTypes[Math.min(Math.floor((wave-1)/2), heroTypes.length-1)];

                game.state.heroes = {
                    name: `${heroName} (LV ${wave})`,
                    hp: heroHp,
                    maxHp: heroHp,
                    power: heroPower,
                    loot: loot
                };

                game.utils.setImage("group of fantasy heroes knights mages entering dark cave glowing weapons battle formation cinematic shot from high angle");
                game.utils.log(`ã€å…¬ä¼šè°ƒåº¦å‘˜ã€‘ï¼šç¬¬ ${wave} æ³¢å®¢äººåˆ°äº†ï¼<b>${game.state.heroes.name}</b>ã€‚æˆ˜åŠ›è¯„ä¼°ï¼š${heroPower}ã€‚`, 'dispatcher');
                game.utils.log(`æ•Œäººæ­£è¯•å›¾çªç ´å¤–å±‚é˜²å¾¡...`, 'danger');

                // Auto-Defense Calculation
                setTimeout(() => game.defenseCalculation(), 1500);
            },

            defenseCalculation: () => {
                const s = game.state;
                const h = s.heroes;
                const totalDefense = s.lair.trapPower + s.lair.minionPower;
                
                game.utils.log(`ä½ çš„å·¢ç©´é˜²å¾¡åŠ›: ${totalDefense} (é™·é˜± ${s.lair.trapPower} + ä»†ä» ${s.lair.minionPower})`);

                // Simple Defense Logic
                // Damage dealt to heroes by defense
                const defenseDmg = totalDefense * (0.8 + Math.random() * 0.4); 
                h.hp -= Math.floor(defenseDmg);

                // Minion casualties
                if (s.lair.minions > 0) {
                    const deadMinions = Math.floor(s.lair.minions * (h.power / (totalDefense + 100)));
                    s.lair.minions = Math.max(0, s.lair.minions - deadMinions);
                    s.lair.minionPower = s.lair.minions * 4; // Update power
                    if (deadMinions > 0) game.utils.log(`é˜²å¾¡æˆ˜ä¸­ç‰ºç‰²äº† ${deadMinions} ä¸ªä»†ä»ï¼`, 'danger');
                }

                if (h.hp <= 0) {
                    // Full Defense Success
                    game.utils.log(`<b>å¤–å±‚é˜²å¾¡å®Œå…¨å‡»æºƒäº†å…¥ä¾µè€…ï¼</b>çœŸæ˜¯æ¯«ä¸è´¹åŠ›ã€‚`, 'gain');
                    game.waveWin();
                } else {
                    // Breach
                    game.utils.log(`<b>é˜²çº¿è¢«çªç ´ï¼</b>æ®‹å­˜çš„è‹±é›„ä»¬å†²å…¥äº†ä½ çš„ç‹åº§å¤§å…ï¼(è‹±é›„å‰©ä½™HP: ${h.hp})`, 'danger');
                    setTimeout(() => game.bossFightStart(), 1500);
                }
                game.utils.updateUI();
            },

            bossFightStart: () => {
                game.utils.setImage("giant dragon facing tiny heroes inside grand throne room fire breath preparing epic cinematic");
                game.utils.log("ä½ å‘å‡ºäº†éœ‡è€³æ¬²è‹çš„å’†å“®ï¼Œäº²è‡ªä¸‹åœºæˆ˜æ–—ï¼", 'highlight');
                
                const controls = document.getElementById('controls');
                controls.innerHTML = '';
                controls.className = 'grid grid-cols-2 gap-2';

                // Setup combat buttons
                const attacks = [
                    { text: "é¾™çˆªæ¨ªæ‰«", action: () => game.bossAttack('claw') },
                    { text: "ç‚¼ç‹±é¾™æ¯ (AOE)", action: () => game.bossAttack('breath') }
                ];
                attacks.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = 'btn-action text-lg py-4';
                    b.innerText = btn.text;
                    b.onclick = btn.action;
                    controls.appendChild(b);
                });
            },

            bossAttack: (type) => {
                const s = game.state;
                const h = s.heroes;
                let dmg = 0;
                let msg = "";

                if (type === 'claw') {
                    dmg = s.boss.power * (1 + Math.random() * 0.5);
                    msg = `ä½ æŒ¥èˆå·¨çˆªï¼Œå°†è‹±é›„ä»¬æ‹é£ï¼Œé€ æˆ ${Math.floor(dmg)} ç‚¹ä¼¤å®³ã€‚`;
                } else {
                    dmg = s.boss.power * 1.5;
                    msg = `ä½ æ·±å¸ä¸€å£æ°”ï¼Œå–·å‡ºæ¯ç­æ€§çš„çƒˆç„°ï¼é€ æˆ ${Math.floor(dmg)} ç‚¹ä¼¤å®³ã€‚`;
                }

                h.hp -= Math.floor(dmg);
                game.utils.log(msg, 'combat');
                
                if (h.hp <= 0) {
                    game.waveWin();
                } else {
                    setTimeout(game.heroTurn, 1000);
                }
            },

            heroTurn: () => {
                const s = game.state;
                const h = s.heroes;
                
                const dmg = h.power * (0.8 + Math.random() * 0.4);
                s.boss.hp -= Math.floor(dmg);
                
                game.utils.log(`è‹±é›„ä»¬å‘èµ·äº†åå‡»ï¼ä½ çš„é¾™é³å´©è£‚ï¼Œå—åˆ°äº† ${Math.floor(dmg)} ç‚¹ä¼¤å®³ã€‚`, 'danger');
                game.utils.updateUI();

                if (s.boss.hp <= 0) {
                    game.gameOver();
                } else {
                    // Back to player turn (buttons remain active)
                }
            },

            waveWin: () => {
                const s = game.state;
                const reward = s.heroes.loot;
                s.gold += reward;
                game.utils.log(`è¿™ä¸€æ³¢è‹±é›„è¢«æ¶ˆç­äº†ã€‚ä½ ä»å°¸ä½“ä¸Šæœåˆ®äº† ${reward} é‡‘å¸ã€‚`, 'gain');
                
                // Stat growth
                s.boss.power += 10;
                game.utils.log("ç»å†äº†æˆ˜æ–—ï¼Œä½ çš„é¾™å¨å¢å¼ºäº† (+10 Power)ã€‚", 'magic');

                if (s.wave >= s.maxWaves) {
                    game.victory();
                } else {
                    s.wave++;
                    game.utils.updateUI();
                    
                    const controls = document.getElementById('controls');
                    controls.innerHTML = '';
                    const b = document.createElement('button');
                    b.className = 'btn-action col-span-3 text-lg font-bold';
                    b.innerText = "è¿›å…¥ä¸‹ä¸€è½®å»ºè®¾é˜¶æ®µ";
                    b.onclick = game.constructionPhase;
                    controls.appendChild(b);
                }
            },

            gameOver: () => {
                game.utils.setImage("dead dragon massive corpse surrounded by cheering heroes tragic sad ending");
                game.utils.log("ã€å…¬ä¼šè°ƒåº¦å‘˜ã€‘ï¼šå“å‘€...çœ‹æ¥ä¼ è¯´ç»ˆç»“äº†ã€‚æˆ‘ä¼šæƒ³å¿µä½ çš„ï¼Œé¡ºä¾¿è¯´ä¸€å¥ï¼Œä½ çš„é¾™çš®èƒ½å–ä¸ªå¥½ä»·é’±ã€‚", 'dispatcher');
                game.utils.log("GAME OVER - ä½ è¢«å± é¾™äº†ã€‚", 'danger');
                document.getElementById('controls').innerHTML = '<button onclick="location.reload()" class="btn-action col-span-3">æŠ•èƒè½¬ä¸– (é‡ç½®)</button>';
            },

            victory: () => {
                game.utils.setImage("dragon sleeping on massive mountain of gold treasure happy ending cinematic");
                game.utils.log("ã€å…¬ä¼šè°ƒåº¦å‘˜ã€‘ï¼šéš¾ä»¥ç½®ä¿¡...ä½ å±…ç„¶æ´»ä¸‹æ¥äº†ï¼Ÿå¥½å§ï¼Œä½ æ˜¯è¿™é‡Œçš„éœ¸ä¸»äº†ã€‚æˆ‘å¾—å»åˆ«çš„é¢†åœ°æ‰¾ä¹å­äº†ã€‚", 'dispatcher');
                game.utils.log("èƒœåˆ©ï¼æ‰€æœ‰çš„è‹±é›„éƒ½å·²é™¨è½ï¼Œä½ çš„å®è—å®‰å…¨äº†ã€‚", 'gain');
                document.getElementById('controls').innerHTML = '<button onclick="location.reload()" class="btn-action col-span-3">å†æ¬¡å®ˆæŠ¤ (é‡ç½®)</button>';
            }
        };
    </script>
</body>
</html>
